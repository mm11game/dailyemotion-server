// Copyright 2020 - Sleepless Software Inc. - All Rights Reserved

let https = require("https");

function hreq( options, cb_okay, cb_fail ) {
	let body = "";
	let req = https.request( options.url, options, res => {
		let code = res.statusCode;
		let hdrs = res.headers;
		res.setEncoding( options.encoding || "utf8" );
		res.on('data', chunk => { body += chunk; });
		res.on('end', () => {
			if( hdrs["content-type"] == "application/json" ) {
				body = JSON.parse( body );
			}
			if( code >= 300  && code < 400 ) {
				options.url = hdrs[ "location" ] || hdrs[ "Location" ];
				hreq( options, cb_okay, cb_fail );
			}
			else {
				if( code >= 200  && code < 300 ) {
					if( cb_okay )
						cb_okay( body, res );
				} else {
					if( cb_fail )
						cb_fail( "HTTP ERROR "+code, res );
				}
			}
		});
	});
	if( cb_fail )
		req.on( "error", cb_fail );
	let data = options.data;
	if( data ) {
		if( typeof data === "object" ) {
			data = JSON.stringify( data );
		}
		req.write( data );
	}
	req.end();
}


if(require && require.main === module) {
	// module is being executed directly - run tests
	let url = process.argv[ 2 ] || "https://api.sleepless.com";
	hreq( { url }, html => {
		console.log( "Okay!" );
		process.exit( 0 );
	}, err => {
		console.error( err );
		process.exit( 1 );
	});
} else {
	module.exports = hreq;
}


